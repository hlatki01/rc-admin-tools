<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/assets/img/logo.png">

    <title>Rocket.Chat Admin Tools</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/sign-in/">

    <!-- Bootstrap core CSS -->
    <link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="https://getbootstrap.com/docs/4.0/examples/sign-in/signin.css" rel="stylesheet">

    <style>
      input{
        margin-top: 5px;
      }

      #loading {
        position: fixed;
        display: none;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        text-align: center;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
      }

      #loading-image {
        position: absolute;
        margin: auto;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        }

    </style>
  </head>

  <div id="loading">
    <img id="loading-image" src="/assets/img/Rocket.gif" alt="Loading..." />
  </div>


  <body class="text-center">
    <form id="login-form" class="form-signin">
      <img class="mb-4" src="/assets/img/logo.png" alt="" width="72" height="72">

      <h5 class="h5 mb-6 font-weight-small">Rocket.Chat Admin Tools</h5>

      <h1 class="h3 mb-3 font-weight-normal">Please sign in</h1>

      <label for="serverUrl"  class="sr-only">Server Address</label>
      <input type="text" class="form-control" id="serverUrl" placeholder="Enter the server Url" name="serverUrl" value="<%= server %>">

      <label for="username" class="sr-only">Username</label>
      <input type="text" id="username" name="username" class="form-control" placeholder="Username" autofocus required  value="<%= username %>">

      <label for="inputPassword" class="sr-only">Password</label>
      <input type="password" id="password" name="password" class="form-control" placeholder="Password" required>
      
      <div class="checkbox mb-3" id="error">        
      </div>
      <button class="btn btn-lg btn-primary btn-block" type="submit" id="login-form-submit">Sign in</button>
    </form>
    
  </body>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>


  <script>

    const loginForm = document.getElementById("login-form");
    const loginButton = document.getElementById("login-form-submit");
    const loginErrorMsg = document.getElementById("login-error-msg");


    loginButton.addEventListener("click", (e) => {
        e.preventDefault();
        login(loginForm.serverUrl.value, loginForm.username.value, loginForm.password.value)
    })

    checkConfig()
    function checkConfig(){
      configs = JSON.parse(localStorage.getItem('configs'))

      if(configs.authToken){
        window.location.href = "/tools"
      }
    }


    async function login(url, username, password){   
      $('#loading').show();

      let response = await fetch(`${url}/api/v1/login`, {
        method: 'post',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          user: username,
          password: password
                   
        })
      })
      let data = await response.json()
      let error = ''



      if(data.status === 'success'){
        $('#loading').hide();

        let isAdmin = data.data.me.roles.includes("admin");
        if(isAdmin){
          setConfigs(url, username, data.data.authToken, data.data.userId)
          window.location.href = "/tools"
        }
        else{
          alertAction('You need to use an admin account in order to perform actions.')
        }
      }

      if(data.status === 'error'){   
        $('#loading').hide();
     
        alertAction(data.message)
      }
    }

    function alertAction(message){
      document.getElementById("error").insertAdjacentHTML("afterend", '<div id="error-message" class="alert alert-danger" role="alert">'+message+'</div>')
      setTimeout(() => { 
        let elem = document.getElementById("error-message");
        elem.remove();
       }, 3000);
    }

    function setConfigs(serverUrl, username, authToken, userId){
      const configs = {
        serverUrl: serverUrl,
        username: username,
        authToken: authToken,
        userId: userId
      }

      localStorage.setItem('configs', JSON.stringify(configs));

    }
      

   

  </script>
</html>

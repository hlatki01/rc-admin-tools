<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="/assets/img/logo.png">

  <title>Rocket.Chat Admin Tools</title>

  <!-- Bootstrap core CSS -->
  <link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="assets/css/login.css">

</head>

<div id="loading">
  <img id="loading-image" src="/assets/img/Rocket.gif" alt="Loading..." />
</div>


<body class="text-center">
  <form id="login-form" class="form-signin">
    <img class="mb-4" src="/assets/img/logo.png" alt="" width="72" height="72">

    <h5 class="h5 mb-6 font-weight-small">Rocket.Chat Admin Tools</h5>

    <h1 class="h3 mb-3 font-weight-normal">Please sign in</h1>

    <label for="serverUrl" class="sr-only">Server Address</label>
    <input type="text" class="form-control" id="serverUrl" placeholder="Enter the server Url" name="serverUrl" required>

    <label for="username" class="sr-only">Username</label>
    <input type="text" id="username" name="username" class="form-control" placeholder="Username" autofocus required>

    <label for="inputPassword" class="sr-only">Password</label>
    <input type="password" id="password" name="password" class="form-control" placeholder="Password" required>

    <div class="checkbox mb-3" id="error">
    </div>

    <div style="text-align: center; padding: 15px;">
      Having troubles with CORS? Check out the readme <a href="https://github.com/hlatki01/rc-admin-tools"
        target="_blank" style="font-weight: bold;">here</a>.
    </div>
    <button class="btn btn-lg btn-primary btn-block" type="submit" id="login-form-submit">Sign in</button>
    <div class="icons" style="padding: 15px;">
      <a href="https://github.com/hlatki01/rc-admin-tools" target="_blank"><i class="fa-brands fa-github"
          style="padding: 5px; color: black;"></i></a>
      <a href="https://open.rocket.chat/direct/luis.hlatki" target="_blank"><i class="fa-brands fa-rocketchat"
          style="padding: 5px; color: red;"></i></a>

    </div>

  </form>




</body>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/3f0213fd83.js" crossorigin="anonymous"></script>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="/assets/js/libs.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/validate.js/0.13.1/validate.min.js"></script>





<script>

  const loginForm = document.getElementById("login-form");
  const loginButton = document.getElementById("login-form-submit");
  const loginErrorMsg = document.getElementById("login-error-msg");

  function isValidURL(string) {
    var res = string.match(/(https?:\/\/(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9])(:?\d*)\/?([a-z_\/0-9\-#.]*)\??([a-z_\/0-9\-#=&]*)/g);
    return (res !== null)
  };




  loginButton.addEventListener("click", (e) => {
    e.preventDefault();

    if (isValidURL(loginForm.serverUrl.value)) {
      if (!loginForm.username.value || !loginForm.password.value || !loginForm.serverUrl.value) {
        sendInformation(`Error: User, Password and Server URL are required`, "error");
      }else{
        login(loginForm.serverUrl.value, loginForm.username.value, loginForm.password.value)
      }

    }
    else {
      sendInformation(`The URL doesn't seems to be a valid Rocket.Chat server`, "error");
    }

  })

  checkConfig()
  function checkConfig() {
    configs = JSON.parse(localStorage.getItem('configs'))

    if (configs) {
      window.location.href = "/tools"
    }
  }


  async function login(url, username, password) {
    $('#loading').show();

    try {
      let response = await fetch(`${url}/api/v1/login`, {
        method: 'post',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          user: username,
          password: password

        })
      })

      let data = await response.json()
      let error = ''

      if (data.status === 'success') {
        $('#loading').hide();

        let isAdmin = data.data.me.roles.includes("admin");
        if (isAdmin) {
          setConfigs(url, username, data.data.authToken, data.data.userId)
          window.location.href = "/tools"
        }
        else {
          sendInformation(`You need to use an admin account in order to perform actions.`, "error");
        }
      }

      if (data.status === 'error') {
        console.log(data);
        $('#loading').hide();
        sendInformation(`Error: ${data.message}`, "error");
      }


    } catch (error) {
      $('#loading').hide();
      sendInformation(`The URL doesn't seems to be a valid Rocket.Chat server`, "error");
    }
  }

  function setConfigs(serverUrl, username, authToken, userId) {
    const configs = {
      serverUrl: serverUrl,
      username: username,
      authToken: authToken,
      userId: userId
    }

    localStorage.setItem('configs', JSON.stringify(configs));

  }

</script>

</html>